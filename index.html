<!DOCTYPE html>
<html lang="en">



<body>
  <main>
<script>
  const player = document.getElementById('player');
  const building = document.getElementById('building');
  const shopTab = document.getElementById('shopTab');
  const tiles = Array.from(document.querySelectorAll('.tile'));
  const tilesRow = document.getElementById('tilesRow');

  const containerSize = 400;
  const playerSize = 40;

  let posX = 180;
  let posY = 180;
  const speed = 3;
  let selectedTool = '';
  const keys = { w: false, a: false, s: false, d: false };

  // Track which tiles are wet
  let wetTiles = Array(tiles.length).fill(false);

  // Track dry timeouts for each tile so we can reset them
  let dryTileTimeouts = Array(tiles.length).fill(null);

  window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    if (key in keys) {
      keys[key] = true;
      e.preventDefault();
    }
  });

  window.addEventListener('keyup', (e) => {
    const key = e.key.toLowerCase();
    if (key in keys) {
      keys[key] = false;
      e.preventDefault();
    }
  });

  function isColliding(rect1, rect2) {
    return !(
      rect1.right <= rect2.left ||
      rect1.left >= rect2.right ||
      rect1.bottom <= rect2.top ||
      rect1.top >= rect2.bottom
    );
  }

  function canMove(newX, newY) {
    const newRect = {
      left: newX,
      right: newX + playerSize,
      top: newY,
      bottom: newY + playerSize
    };

    // Building collision
    const buildingRect = building.getBoundingClientRect();
    const containerRect = player.parentElement.getBoundingClientRect();
    // Adjust rects to be relative to container
    const offsetLeft = containerRect.left;
    const offsetTop = containerRect.top;
    const buildingRel = {
      left: building.offsetLeft,
      right: building.offsetLeft + building.offsetWidth,
      top: building.offsetTop,
      bottom: building.offsetTop + building.offsetHeight
    };

    if (isColliding(newRect, buildingRel)) return false;
    if (newX < 0 || newY < 0 || newX > containerSize - playerSize || newY > containerSize - playerSize) return false;

    return true;
  }

  // FIXED: Get tile rect relative to container using getBoundingClientRect
  function getTileRect(tile) {
    const containerRect = player.parentElement.getBoundingClientRect();
    const tileRect = tile.getBoundingClientRect();
    return {
      left: tileRect.left - containerRect.left,
      right: tileRect.right - containerRect.left,
      top: tileRect.top - containerRect.top,
      bottom: tileRect.bottom - containerRect.top
    };
  }

  function wetNearbyTiles() {
    // Only wet tiles if watering-can is selected
    if (selectedTool !== 'watering-can') return;

    const playerRect = {
      left: posX,
      right: posX + playerSize,
      top: posY,
      bottom: posY + playerSize
    };

    tiles.forEach((tile, i) => {
      const tileRect = getTileRect(tile);
      if (isColliding(playerRect, tileRect)) {
        if (!wetTiles[i]) {
          wetTiles[i] = true;

          // Set a timeout to dry the tile after 2 minutes (120000 ms)
          if (dryTileTimeouts[i]) clearTimeout(dryTileTimeouts[i]);
          dryTileTimeouts[i] = setTimeout(() => {
            wetTiles[i] = false;
            renderTiles();
          }, 120000); // 2 minutes
        }
      }
    });
  }

  function renderTiles() {
    tiles.forEach((tile, i) => {
      if (wetTiles[i]) {
        tile.style.background = 'rgb(120,65,30)'; // darker brown
      } else {
        tile.style.background = 'sienna'; // dry color
      }
    });
  }

  function movePlayer() {
    let newX = posX;
    let newY = posY;

    if (keys.w) newY = Math.max(0, posY - speed);
    if (keys.a) newX = Math.max(0, posX - speed);
    if (keys.s) newY = Math.min(containerSize - playerSize, posY + speed);
    if (keys.d) newX = Math.min(containerSize - playerSize, posX + speed);

    if (canMove(newX, newY)) {
      posX = newX;
      posY = newY;
    }

    player.style.top = posY + 'px';
    player.style.left = posX + 'px';

    // Shop tab
    const playerRect = {
      left: posX,
      right: posX + playerSize,
      top: posY,
      bottom: posY + playerSize
    };
    const buildingRect = {
      left: building.offsetLeft,
      right: building.offsetLeft + building.offsetWidth,
      top: building.offsetTop,
      bottom: building.offsetTop + building.offsetHeight
    };

    if (isColliding(playerRect, buildingRect)) {
      shopTab.style.display = 'block';
    } else {
      shopTab.style.display = 'none';
    }

    // Wet tiles if needed
    wetNearbyTiles();
    renderTiles();

    requestAnimationFrame(movePlayer);
  }

  function selectTool(tool) {
    const toolIcons = {
      'hoe': 'ü™í',
      'watering-can': 'üíß',
      'shovel': 'üõ†Ô∏è'
    };
    selectedTool = tool;
    player.innerText = toolIcons[tool] || '';
  }

  renderTiles();
  movePlayer();
</script>

</body>

</html>
