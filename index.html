<!DOCTYPE html>
<html lang="en">



<body>
  <main>
<div style="width: 400px; height: 480px; border: 2px solid #333; margin: 20px auto; position: relative; background: #7CFC00; font-family: Arial, sans-serif;">
  <!-- Row of 10 brown tiles near the top -->
  <div id="tilesRow" style="display: flex; justify-content: center; gap: 4px; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 380px; z-index: 10;">
    <div class="tile" data-tile="0" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="1" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="2" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="3" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="4" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="5" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="6" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="7" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="8" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="9" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
  </div>
  <!-- Fence line (tan) at 400px -->
  <div style="position: absolute; bottom: 80px; left: 0; width: 100%; height: 10px; background: tan; z-index: 15;"></div>
  <!-- Tool selection area (below shop but above grass) -->
  <div style="position: absolute; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 20;">
    <div onclick="selectTool('hoe')" id="hoeTool" style="cursor: pointer; font-size: 20px;">ü™í</div>
    <div onclick="selectTool('watering-can')" style="cursor: pointer; font-size: 20px;">üíß</div>
    <div onclick="selectTool('shovel')" style="cursor: pointer; font-size: 20px;">üõ†Ô∏è</div>
  </div>
  <!-- Small building -->
  <div id="building" style="width: 60px; height: 80px; background: gray; border-radius: 6px; position: absolute; bottom: 100px; right: 20px; z-index: 10; box-shadow: 2px 2px 6px rgba(0,0,0,0.4);">
    <div style="width: 20px; height: 20px; background: #444; margin: 10px auto; border-radius: 3px;"></div>
  </div>
  <!-- Wheat button -->
  <button id="wheatBtn" style="position: absolute; left: 15px; top: 10px; z-index: 30; padding: 6px 18px; border-radius: 7px; font-size: 15px; background: gold; color: #222; border: 1px solid #aaa; cursor: pointer;">
    Wheat
  </button>
  <!-- Movable circle -->
  <div id="player" style="width: 40px; height: 40px; background: #2196f3; border-radius: 50%; position: absolute; top: 180px; left: 180px; z-index: 20; display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
  <!-- Shop tab (hidden by default) -->
  <div id="shopTab" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: #fff; border-top: 2px solid #333; box-shadow: 0 -5px 10px rgba(0,0,0,0.2); padding: 15px; box-sizing: border-box; font-size: 16px; color: #333; display: none; z-index: 25;">
    <strong>Shop:</strong> Welcome! You can buy cool upgrades here.
  </div>
  <!-- Wheat window -->
  <div id="wheatWindow" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 170px; background: #fff; border-top: 2px solid #333; box-shadow: 0 -5px 10px rgba(0,0,0,0.2); padding: 20px 20px 10px 20px; box-sizing: border-box; font-size: 17px; color: #333; display: none; z-index: 26;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <span style="font-size: 22px; font-weight: 600;">Wheat Inventory</span>
      <button id="closeWheatWindow" style="font-size:17px; background: #eee; border-radius: 6px; padding: 2px 12px; border: 1px solid #aaa; cursor: pointer;">Close</button>
    </div>
    <div style="margin-top:18px; font-size:16px;">
      <div><span style="font-size:21px;">üåæ</span> Wheat: <span id="wheatCountDisplay">0</span></div>
      <div><span style="font-size:16px;">üå∞</span> Seeds: <span id="wheatSeedCountMenu">0</span></div>
      <div style="margin-top:12px;">Total wheat harvested: <span id="totalWheatHarvested">0</span></div>
    </div>
    <div style="position: absolute; right: 16px; bottom: 8px; font-size: 13px;">(press C or Close to exit)</div>
  </div>
  <!-- Grass container -->
  <div id="grassContainer"></div>
  <div id="grassToggleInfo" style="position: absolute; left: 12px; bottom: 110px; font-size: 12px; z-index: 30; background: #fff8; border-radius: 8px; padding: 4px 10px; color: #333;">
    Press <b>G</b> to toggle grass spawning<br>
    <span id="grassStatusText" style="color: green;">Grass: ON</span>
  </div>
  <script>
    const player = document.getElementById('player');
    const building = document.getElementById('building');
    const shopTab = document.getElementById('shopTab');
    const wheatWindow = document.getElementById('wheatWindow');
    const wheatCountDisplay = document.getElementById('wheatCountDisplay');
    const wheatSeedCountMenu = document.getElementById('wheatSeedCountMenu');
    const totalWheatHarvestedEl = document.getElementById('totalWheatHarvested');
    const closeWheatWindowBtn = document.getElementById('closeWheatWindow');
    const wheatBtn = document.getElementById('wheatBtn');
    const tiles = Array.from(document.querySelectorAll('.tile'));
    const tilesRow = document.getElementById('tilesRow');
    const grassContainer = document.getElementById('grassContainer');
    const wheatSeedCountEl = document.getElementById('wheatSeedCount');
    const grassStatusText = document.getElementById('grassStatusText');

    const containerSize = 400;
    const playerSize = 40;

    let posX = 180;
    let posY = 180;
    const speed = 3;
    let selectedTool = '';
    const keys = { w: false, a: false, s: false, d: false };
    let wheatWindowVisible = false;
    let grassEnabled = true;

    let wetTiles = Array(tiles.length).fill(false);
    let dryTileTimeouts = Array(tiles.length).fill(null);

    // Grass and wheat seed variables
    let grassList = [];
    let wheatSeedCount = 0;
    let wheatCount = 0; // This variable tracks harvested wheat
    let totalWheatHarvested = 0;

    // Wheat/crop state for each tile
    let tileCrops = Array(tiles.length).fill(null);

    // Remove seed display next to hoe
    wheatSeedCountEl.style.display = "none";

    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key in keys) {
        keys[key] = true;
        e.preventDefault();
      }
      // Toggle wheat window with "c"
      if (key === "c") {
        toggleWheatWindow();
      }
      // Toggle grass with "g"
      if (key === "g") {
        grassEnabled = !grassEnabled;
        grassStatusText.textContent = grassEnabled ? "Grass: ON" : "Grass: OFF";
        grassStatusText.style.color = grassEnabled ? "green" : "red";
      }
    });

    window.addEventListener('keyup', (e) => {
      const key = e.key.toLowerCase();
      if (key in keys) {
        keys[key] = false;
        e.preventDefault();
      }
    });

    wheatBtn.addEventListener("click", toggleWheatWindow);
    closeWheatWindowBtn.addEventListener("click", () => {
      wheatWindowVisible = false;
      wheatWindow.style.display = "none";
    });

    function toggleWheatWindow() {
      wheatWindowVisible = !wheatWindowVisible;
      wheatWindow.style.display = wheatWindowVisible ? "block" : "none";
      updateWheatMenu();
    }

    function updateWheatMenu() {
      wheatSeedCountMenu.textContent = wheatSeedCount;
      wheatCountDisplay.textContent = wheatCount;
      totalWheatHarvestedEl.textContent = totalWheatHarvested;
    }

    function isColliding(rect1, rect2) {
      return !(
        rect1.right <= rect2.left ||
        rect1.left >= rect2.right ||
        rect1.bottom <= rect2.top ||
        rect1.top >= rect2.bottom
      );
    }

    function canMove(newX, newY) {
      const newRect = {
        left: newX,
        right: newX + playerSize,
        top: newY,
        bottom: newY + playerSize
      };

      // Building collision
      const buildingRectAbs = building.getBoundingClientRect();
      const containerRect = player.parentElement.getBoundingClientRect();
      const buildingRel = {
        left: buildingRectAbs.left - containerRect.left,
        right: buildingRectAbs.right - containerRect.left,
        top: buildingRectAbs.top - containerRect.top,
        bottom: buildingRectAbs.bottom - containerRect.top
      };

      if (isColliding(newRect, buildingRel)) return false;
      if (newX < 0 || newY < 0 || newX > containerSize - playerSize || newY > containerSize - playerSize) return false;

      return true;
    }

    function getTileRect(tile) {
      const containerRect = player.parentElement.getBoundingClientRect();
      const tileRect = tile.getBoundingClientRect();
      return {
        left: tileRect.left - containerRect.left,
        right: tileRect.right - containerRect.left,
        top: tileRect.top - containerRect.top,
        bottom: tileRect.bottom - containerRect.top
      };
    }

    function wetNearbyTiles() {
      if (selectedTool !== 'watering-can') return;

      const playerRect = {
        left: posX,
        right: posX + playerSize,
        top: posY,
        bottom: posY + playerSize
      };

      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        if (isColliding(playerRect, tileRect)) {
          if (!wetTiles[i]) {
            wetTiles[i] = true;
            // Mark crop as watered if planted
            if (tileCrops[i] && tileCrops[i].planted) {
              tileCrops[i].watered = true;
              tryStartCropGrowth(i);
            }
            if (dryTileTimeouts[i]) clearTimeout(dryTileTimeouts[i]);
            dryTileTimeouts[i] = setTimeout(() => {
              wetTiles[i] = false;
              renderTiles();
            }, 120000);
          }
        }
      });
    }

    function renderTiles() {
      tiles.forEach((tile, i) => {
        // Tile background
        tile.style.background = wetTiles[i] ? 'rgb(120,65,30)' : 'sienna';
        // Crop rendering
        let crop = tileCrops[i];
        // Remove previous crop visuals
        let cropEl = tile.querySelector('.crop');
        if (cropEl) tile.removeChild(cropEl);

        if (crop && crop.planted) {
          cropEl = document.createElement('div');
          cropEl.className = 'crop';
          cropEl.style.position = 'absolute';
          cropEl.style.left = '50%';
          cropEl.style.top = '50%';
          cropEl.style.transform = 'translate(-50%, -50%)';
          cropEl.style.pointerEvents = 'none';

          if (crop.stage === 0) {
            cropEl.innerHTML = '<span style="font-size:16px; transition:all 0.5s;">üå∞</span>'; // seed
          } else if (crop.stage === 1) {
            cropEl.innerHTML = '<span style="font-size:17px; transition:all 0.5s;">üå±</span>'; // sprout
          } else if (crop.stage === 2) {
            cropEl.innerHTML = '<span style="font-size:18px; transition:all 0.5s;">üåæ</span>'; // growing wheat
          } else if (crop.stage === 3) {
            cropEl.innerHTML = '<span style="font-size:20px; transition:all 0.5s;">üåæ</span>'; // fully grown wheat
            cropEl.style.filter = 'drop-shadow(0 0 3px gold)';
            cropEl.style.animation = 'wheat-sway 1s infinite alternate';
          }
          tile.appendChild(cropEl);
        }
      });
      updateWheatMenu();
    }

    // Animation for wheat
    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes wheat-sway {
        0% { transform: translate(-50%, -50%) rotate(-2deg);}
        100% { transform: translate(-50%, -50%) rotate(2deg);}
      }
    `;
    document.head.appendChild(style);

    // Helper: get all tile rects (relative to container)
    function getAllTileRects() {
      return tiles.map(getTileRect);
    }

    // Helper: check if a rect collides with any tile
    function collidesWithAnyTile(grassRect, tileRects) {
      return tileRects.some(tileRect => isColliding(grassRect, tileRect));
    }

    // GRASS LOGIC
    function spawnGrass() {
      // Limit: only spawn if < 5 grass
      if (!grassEnabled) return;
      if (grassList.length >= 5) return;

      // Get all tile rects
      const tileRects = getAllTileRects();

      // Try to spawn at valid position
      let tries = 0;
      let grassX, grassY;
      let ok = false;
      while (!ok && tries < 40) {
        grassX = Math.floor(Math.random() * (containerSize - 24));
        grassY = Math.floor(Math.random() * (containerSize - 24));
        // Don't spawn on shop/building or tiles
        const grassRect = {
          left: grassX,
          right: grassX + 24,
          top: grassY,
          bottom: grassY + 24
        };
        const buildingRectAbs = building.getBoundingClientRect();
        const containerRect = player.parentElement.getBoundingClientRect();
        const buildingRel = {
          left: buildingRectAbs.left - containerRect.left,
          right: buildingRectAbs.right - containerRect.left,
          top: buildingRectAbs.top - containerRect.top,
          bottom: buildingRectAbs.bottom - containerRect.top
        };
        ok = !isColliding(grassRect, buildingRel) && !collidesWithAnyTile(grassRect, tileRects);
        tries++;
      }
      if (!ok) return; // Give up if can't find

      // Create grass element
      const grass = document.createElement('div');
      grass.className = 'grass-item';
      grass.style.position = 'absolute';
      grass.style.left = grassX + 'px';
      grass.style.top = grassY + 'px';
      grass.style.width = '24px';
      grass.style.height = '24px';
      grass.style.background = 'linear-gradient(135deg,#6b8e23 70%,#9acd32 100%)';
      grass.style.borderRadius = '50%';
      grass.style.boxShadow = '0 2px 8px #0002';
      grass.style.zIndex = 18;
      grass.style.display = 'flex';
      grass.style.alignItems = 'center';
      grass.style.justifyContent = 'center';
      grass.innerHTML = 'üå±';
      grassContainer.appendChild(grass);
      grassList.push({ el: grass, x: grassX, y: grassY });
    }

    function removeGrass(grassObj) {
      grassContainer.removeChild(grassObj.el);
      grassList = grassList.filter(g => g !== grassObj);
    }

    function checkGrassPickup() {
      // Only harvest grass if shovel is equipped
      if (selectedTool !== 'shovel') return;

      // Player rect
      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };
      grassList.forEach(grassObj => {
        const grassRect = {
          left: grassObj.x,
          right: grassObj.x + 24,
          top: grassObj.y,
          bottom: grassObj.y + 24
        };
        if (isColliding(playerRect, grassRect)) {
          // 1/2 chance to get wheat seed
          if (Math.random() < 0.5) {
            wheatSeedCount++;
          }
          removeGrass(grassObj);
        }
      });
      // Never allow negative wheat seeds
      if (wheatSeedCount < 0) wheatSeedCount = 0;
      updateWheatMenu();
    }

    // Planting logic: plant seed in brown tile if hoe equipped & seed available & player touches tile
    function plantSeedOnTile() {
      if (selectedTool !== 'hoe') return;
      if (wheatSeedCount <= 0) return;

      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };

      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        if (
          isColliding(playerRect, tileRect) &&
          (!tileCrops[i] || !tileCrops[i].planted)
        ) {
          // Plant seed
          tileCrops[i] = {
            stage: 0,
            planted: true,
            watered: wetTiles[i],
            growTimeout: null
          };
          wheatSeedCount = Math.max(0, wheatSeedCount - 1);
          updateWheatMenu();
          renderTiles();
          tryStartCropGrowth(i);
        }
      });
    }

    // Try to start crop growth for a tile if possible
    function tryStartCropGrowth(i) {
      const crop = tileCrops[i];
      if (!crop || !crop.planted) return;
      // Must be watered and not already fully grown
      if (!crop.watered || crop.stage >= 3) return;
      if (crop.growTimeout) return; // already growing

      // Growth animation: every 10s advance stage. At stage 3, full grown.
      crop.growTimeout = setTimeout(() => {
        crop.stage++;
        crop.growTimeout = null;
        renderTiles();
        if (crop.stage < 3 && crop.watered) {
          tryStartCropGrowth(i); // grow next stage
        }
      }, 10000); // 10s per stage, total 30s
    }

    // Harvest logic: harvest grown wheat with shovel
    function harvestWheat() {
      if (selectedTool !== 'shovel') return;

      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };

      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        const crop = tileCrops[i];
        if (
          isColliding(playerRect, tileRect) &&
          crop &&
          crop.planted &&
          crop.stage === 3
        ) {
          // Harvest wheat
          tileCrops[i] = null;
          wheatCount++;
          totalWheatHarvested++;
          wheatSeedCount++; // Harvesting wheat gives a seed
          updateWheatMenu();
          renderTiles();
        }
      });
      // Never allow negative wheat seeds
      if (wheatSeedCount < 0) wheatSeedCount = 0;
      updateWheatMenu();
    }

    // Spawn grass every 10 seconds
    setInterval(spawnGrass, 10000);

    function movePlayer() {
      let newX = posX;
      let newY = posY;

      if (keys.w) newY = Math.max(0, posY - speed);
      if (keys.a) newX = Math.max(0, posX - speed);
      if (keys.s) newY = Math.min(containerSize - playerSize, posY + speed);
      if (keys.d) newX = Math.min(containerSize - playerSize, posX + speed);

      if (canMove(newX, newY)) {
        posX = newX;
        posY = newY;
      }

      player.style.top = posY + 'px';
      player.style.left = posX + 'px';

      // Shop tab: open when touching the shop
      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };

      const buildingRectAbs = building.getBoundingClientRect();
      const buildingRect = {
        left: buildingRectAbs.left - containerRect.left,
        right: buildingRectAbs.right - containerRect.left,
        top: buildingRectAbs.top - containerRect.top,
        bottom: buildingRectAbs.bottom - containerRect.top
      };

      if (isColliding(playerRect, buildingRect)) {
        shopTab.style.display = 'block';
      } else {
        shopTab.style.display = 'none';
      }

      wetNearbyTiles();
      renderTiles();
      checkGrassPickup();
      plantSeedOnTile();
      harvestWheat();

      requestAnimationFrame(movePlayer);
    }

    function selectTool(tool) {
      const toolIcons = {
        'hoe': 'ü™í',
        'watering-can': 'üíß',
        'shovel': 'üõ†Ô∏è'
      };
      selectedTool = tool;
      player.innerText = toolIcons[tool] || '';
    }

    renderTiles();
    movePlayer();
  </script>
</div>

</body>

</html>
