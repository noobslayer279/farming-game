<!DOCTYPE html>
<html lang="en">



<body>
  <main>
<div style="width: 400px; height: 480px; border: 2px solid #333; margin: 20px auto; position: relative; background: #7CFC00; font-family: Arial, sans-serif;">
  <!-- Row of 10 brown tiles near the top -->
  <div id="tilesRow" style="display: flex; justify-content: center; gap: 4px; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 380px; z-index: 10;">
    <div class="tile" data-tile="0" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="1" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="2" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="3" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="4" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="5" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="6" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="7" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="8" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
    <div class="tile" data-tile="9" style="background: sienna; width: 36px; height: 30px; border-radius: 4px; position: relative;"></div>
  </div>
  <!-- Fence line (tan) at 400px -->
  <div style="position: absolute; bottom: 80px; left: 0; width: 100%; height: 10px; background: tan; z-index: 15;"></div>
  <!-- Tool selection area -->
  <div style="position: absolute; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 20;">
    <div onclick="selectTool('hoe')" id="hoeTool" style="cursor: pointer; font-size: 20px;">ü™í</div>
    <div onclick="selectTool('watering-can')" style="cursor: pointer; font-size: 20px;">üíß</div>
    <div onclick="selectTool('shovel')" style="cursor: pointer; font-size: 20px;">üõ†Ô∏è</div>
  </div>
  <!-- Small building -->
  <div id="building" style="width: 60px; height: 80px; background: gray; border-radius: 6px; position: absolute; bottom: 100px; right: 20px; z-index: 10; box-shadow: 2px 2px 6px rgba(0,0,0,0.4);">
    <div style="width: 20px; height: 20px; background: #444; margin: 10px auto; border-radius: 3px;"></div>
  </div>
  <!-- Movable circle -->
  <div id="player" style="width: 40px; height: 40px; background: #2196f3; border-radius: 50%; position: absolute; top: 180px; left: 180px; z-index: 20; display: flex; align-items: center; justify-content: center; font-size: 24px;"></div>
  <!-- Shop tab FULL SCREEN -->
  <div id="shopTab" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; border: none; box-shadow: none; padding: 0; font-size: 16px; color: #333; display: none; z-index: 100;">
    <!-- Coin counter in shop only (top right) -->
    <div id="coinsDisplay" style="position: absolute; top: 10px; right: 16px; font-size: 22px; font-weight: bold; background: #fffbe7; border-radius: 6px; padding: 6px 16px; border: 1px solid #e5c76e;">
      Coins: <span id="coinCount">0</span>
    </div>
    <!-- Shop content centered -->
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;text-align:center;">
      <strong style="font-size:22px;">Shop</strong>
      <div style="margin:16px 0 24px 0;">Sell your items here!</div>
      <button id="sellSeedsBtn" style="padding:12px 32px; border-radius:10px; font-size:18px; background:#ffe7a1; border:1px solid #aaa; cursor:pointer;">
        Sell Seeds (+0.5 coins)
      </button>
      <button id="sellWheatBtn" style="margin-left:28px; padding:12px 32px; border-radius:10px; font-size:18px; background:#ffd700; border:1px solid #aaa; cursor:pointer;">
        Sell Wheat (+1 coin)
      </button>
      <div style="margin-top:30px;font-size:15px;color:#555;">Leave the shop by moving away from the building.</div>
    </div>
  </div>
  <!-- Wheat menu window (press C to open) -->
  <div id="wheatMenuWindow" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 340px; height: 210px; background: #fff; border: 2px solid #c2a300; border-radius: 18px; box-shadow: 0 0 30px #0002; padding: 28px 34px 15px 34px; box-sizing: border-box; font-size: 17px; color: #333; display: none; z-index: 40;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <span style="font-size: 24px; font-weight: 700;">Inventory & Info</span>
      <button id="closeWheatMenuWindow" style="font-size:17px; background: #eee; border-radius: 6px; padding: 2px 12px; border: 1px solid #aaa; cursor: pointer;">Close</button>
    </div>
    <div style="margin-top:14px;">
      <button id="wheatBtn" style="padding: 10px 38px; border-radius: 8px; font-size: 18px; background: gold; color: #222; border: 2px solid #aaa; cursor: pointer; box-shadow: 0 2px 6px #0002; margin-bottom: 10px;">Wheat</button>
      <div id="wheatWindow" style="display:none; margin-top:8px; width: 100%; background: #fffbe5; border: 2px solid #c2a300; border-radius: 12px; box-shadow: 0 0 12px #0001; padding: 18px 18px 14px 18px;">
        <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">Wheat Inventory</div>
        <div style="margin-top:8px; font-size:17px;">
          <div><span style="font-size:22px;">üåæ</span> Wheat: <span id="wheatCountDisplay">0</span></div>
          <div><span style="font-size:17px;">üå∞</span> Seeds: <span id="wheatSeedCountMenu">0</span></div>
          <div style="margin-top:13px;">Total wheat harvested: <span id="totalWheatHarvested">0</span></div>
        </div>
      </div>
    </div>
    <div style="position: absolute; right: 18px; bottom: 10px; font-size: 13px;">(press Close or C to exit)</div>
  </div>
  <div id="grassContainer"></div>
  <script>
    // ---- SHOP STATE ----
    let coins = 0;

    // Game state variables
    const player = document.getElementById('player');
    const building = document.getElementById('building');
    const shopTab = document.getElementById('shopTab');
    const wheatMenuWindow = document.getElementById('wheatMenuWindow');
    const wheatWindow = document.getElementById('wheatWindow');
    const wheatCountDisplay = document.getElementById('wheatCountDisplay');
    const wheatSeedCountMenu = document.getElementById('wheatSeedCountMenu');
    const totalWheatHarvestedEl = document.getElementById('totalWheatHarvested');
    const closeWheatMenuWindowBtn = document.getElementById('closeWheatMenuWindow');
    const wheatBtn = document.getElementById('wheatBtn');
    const tiles = Array.from(document.querySelectorAll('.tile'));
    const grassContainer = document.getElementById('grassContainer');

    const containerSize = 400;
    const playerSize = 40;

    let posX = 180;
    let posY = 180;
    const speed = 3;
    let selectedTool = '';
    let wheatMenuWindowVisible = false;
    let wheatWindowVisible = false;
    let grassEnabled = true;

    let wetTiles = Array(tiles.length).fill(false);
    let dryTileTimeouts = Array(tiles.length).fill(null);

    let keys = { w: false, a: false, s: false, d: false };

    let grassList = [];
    let wheatSeedCount = 0;
    let wheatCount = 0;
    let totalWheatHarvested = 0;

    let tileCrops = Array(tiles.length).fill(null);

    // Keyboard controls
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (!wheatMenuWindowVisible) {
        if (['w','a','s','d'].includes(key)) {
          keys[key] = true;
          e.preventDefault();
        }
      }
      if (key === "c") {
        wheatMenuWindowVisible = !wheatMenuWindowVisible;
        wheatMenuWindow.style.display = wheatMenuWindowVisible ? "block" : "none";
        wheatWindow.style.display = "none";
        wheatWindowVisible = false;
        updateWheatMenu();
      }
    });

    window.addEventListener('keyup', (e) => {
      const key = e.key.toLowerCase();
      if (!wheatMenuWindowVisible) {
        if (['w','a','s','d'].includes(key)) {
          keys[key] = false;
          e.preventDefault();
        }
      }
    });

    closeWheatMenuWindowBtn.addEventListener("click", () => {
      wheatMenuWindowVisible = false;
      wheatMenuWindow.style.display = "none";
      wheatWindow.style.display = "none";
      wheatWindowVisible = false;
    });

    wheatBtn.addEventListener("click", () => {
      wheatWindowVisible = !wheatWindowVisible;
      wheatWindow.style.display = wheatWindowVisible ? "block" : "none";
      updateWheatMenu();
    });

    function updateWheatMenu() {
      wheatSeedCountMenu.textContent = wheatSeedCount;
      wheatCountDisplay.textContent = wheatCount;
      totalWheatHarvestedEl.textContent = totalWheatHarvested;
    }

    function isColliding(rect1, rect2) {
      return !(
        rect1.right <= rect2.left ||
        rect1.left >= rect2.right ||
        rect1.bottom <= rect2.top ||
        rect1.top >= rect2.bottom
      );
    }

    function canMove(newX, newY) {
      const newRect = {
        left: newX,
        right: newX + playerSize,
        top: newY,
        bottom: newY + playerSize
      };

      const buildingRectAbs = building.getBoundingClientRect();
      const containerRect = player.parentElement.getBoundingClientRect();
      const buildingRel = {
        left: buildingRectAbs.left - containerRect.left,
        right: buildingRectAbs.right - containerRect.left,
        top: buildingRectAbs.top - containerRect.top,
        bottom: buildingRectAbs.bottom - containerRect.top
      };

      if (isColliding(newRect, buildingRel)) return false;
      if (newX < 0 || newY < 0 || newX > containerSize - playerSize || newY > containerSize - playerSize) return false;

      return true;
    }

    function getTileRect(tile) {
      const containerRect = player.parentElement.getBoundingClientRect();
      const tileRect = tile.getBoundingClientRect();
      return {
        left: tileRect.left - containerRect.left,
        right: tileRect.right - containerRect.left,
        top: tileRect.top - containerRect.top,
        bottom: tileRect.bottom - containerRect.top
      };
    }

    function wetNearbyTiles() {
      if (selectedTool !== 'watering-can') return;
      const playerRect = {
        left: posX,
        right: posX + playerSize,
        top: posY,
        bottom: posY + playerSize
      };
      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        if (isColliding(playerRect, tileRect)) {
          if (!wetTiles[i]) {
            wetTiles[i] = true;
            if (tileCrops[i] && tileCrops[i].planted) {
              tileCrops[i].watered = true;
              tryStartCropGrowth(i);
            }
            if (dryTileTimeouts[i]) clearTimeout(dryTileTimeouts[i]);
            dryTileTimeouts[i] = setTimeout(() => {
              wetTiles[i] = false;
              renderTiles();
            }, 120000);
          }
        }
      });
    }

    function renderTiles() {
      tiles.forEach((tile, i) => {
        tile.style.background = wetTiles[i] ? 'rgb(120,65,30)' : 'sienna';
        let crop = tileCrops[i];
        let cropEl = tile.querySelector('.crop');
        if (cropEl) tile.removeChild(cropEl);

        if (crop && crop.planted) {
          cropEl = document.createElement('div');
          cropEl.className = 'crop';
          cropEl.style.position = 'absolute';
          cropEl.style.left = '50%';
          cropEl.style.top = '50%';
          cropEl.style.transform = 'translate(-50%, -50%)';
          cropEl.style.pointerEvents = 'none';
          if (crop.stage === 0) {
            cropEl.innerHTML = '<span style="font-size:16px; transition:all 0.5s;">üå∞</span>';
          } else if (crop.stage === 1) {
            cropEl.innerHTML = '<span style="font-size:17px; transition:all 0.5s;">üå±</span>';
          } else if (crop.stage === 2) {
            cropEl.innerHTML = '<span style="font-size:18px; transition:all 0.5s;">üåæ</span>';
          } else if (crop.stage === 3) {
            cropEl.innerHTML = '<span style="font-size:20px; transition:all 0.5s;">üåæ</span>';
            cropEl.style.filter = 'drop-shadow(0 0 3px gold)';
            cropEl.style.animation = 'wheat-sway 1s infinite alternate';
          }
          tile.appendChild(cropEl);
        }
      });
      updateWheatMenu();
    }

    // Animation for wheat
    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes wheat-sway {
        0% { transform: translate(-50%, -50%) rotate(-2deg);}
        100% { transform: translate(-50%, -50%) rotate(2deg);}
      }
    `;
    document.head.appendChild(style);

    function getAllTileRects() { return tiles.map(getTileRect); }
    function collidesWithAnyTile(grassRect, tileRects) {
      return tileRects.some(tileRect => isColliding(grassRect, tileRect));
    }

    function spawnGrass() {
      if (!grassEnabled) return;
      if (grassList.length >= 5) return;
      const tileRects = getAllTileRects();
      let tries = 0, grassX, grassY, ok = false;
      while (!ok && tries < 40) {
        grassX = Math.floor(Math.random() * (containerSize - 24));
        grassY = Math.floor(Math.random() * (containerSize - 24));
        const grassRect = {
          left: grassX,
          right: grassX + 24,
          top: grassY,
          bottom: grassY + 24
        };
        const buildingRectAbs = building.getBoundingClientRect();
        const containerRect = player.parentElement.getBoundingClientRect();
        const buildingRel = {
          left: buildingRectAbs.left - containerRect.left,
          right: buildingRectAbs.right - containerRect.left,
          top: buildingRectAbs.top - containerRect.top,
          bottom: buildingRectAbs.bottom - containerRect.top
        };
        ok = !isColliding(grassRect, buildingRel) && !collidesWithAnyTile(grassRect, tileRects);
        tries++;
      }
      if (!ok) return;
      const grass = document.createElement('div');
      grass.className = 'grass-item';
      grass.style.position = 'absolute';
      grass.style.left = grassX + 'px';
      grass.style.top = grassY + 'px';
      grass.style.width = '24px';
      grass.style.height = '24px';
      grass.style.background = 'linear-gradient(135deg,#6b8e23 70%,#9acd32 100%)';
      grass.style.borderRadius = '50%';
      grass.style.boxShadow = '0 2px 8px #0002';
      grass.style.zIndex = 18;
      grass.style.display = 'flex';
      grass.style.alignItems = 'center';
      grass.style.justifyContent = 'center';
      grass.innerHTML = 'üå±';
      grassContainer.appendChild(grass);
      grassList.push({ el: grass, x: grassX, y: grassY });
    }

    function removeGrass(grassObj) {
      grassContainer.removeChild(grassObj.el);
      grassList = grassList.filter(g => g !== grassObj);
    }

    function checkGrassPickup() {
      if (selectedTool !== 'shovel') return;
      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };
      grassList.forEach(grassObj => {
        const grassRect = {
          left: grassObj.x,
          right: grassObj.x + 24,
          top: grassObj.y,
          bottom: grassObj.y + 24
        };
        if (isColliding(playerRect, grassRect)) {
          if (Math.random() < 0.5) {
            wheatSeedCount++;
          }
          removeGrass(grassObj);
        }
      });
      if (wheatSeedCount < 0) wheatSeedCount = 0;
      updateWheatMenu();
    }

    function plantSeedOnTile() {
      if (selectedTool !== 'hoe') return;
      if (wheatSeedCount <= 0) return;
      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };
      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        if (isColliding(playerRect, tileRect) && (!tileCrops[i] || !tileCrops[i].planted)) {
          tileCrops[i] = {
            stage: 0,
            planted: true,
            watered: wetTiles[i],
            growTimeout: null
          };
          wheatSeedCount = Math.max(0, wheatSeedCount - 1);
          updateWheatMenu();
          renderTiles();
          tryStartCropGrowth(i);
        }
      });
    }

    function tryStartCropGrowth(i) {
      const crop = tileCrops[i];
      if (!crop || !crop.planted) return;
      if (!crop.watered || crop.stage >= 3) return;
      if (crop.growTimeout) return;
      crop.growTimeout = setTimeout(() => {
        crop.stage++;
        crop.growTimeout = null;
        renderTiles();
        if (crop.stage < 3 && crop.watered) tryStartCropGrowth(i);
      }, 10000);
    }

    function harvestWheat() {
      if (selectedTool !== 'shovel') return;
      const containerRect = player.parentElement.getBoundingClientRect();
      const playerRectAbs = player.getBoundingClientRect();
      const playerRect = {
        left: playerRectAbs.left - containerRect.left,
        right: playerRectAbs.right - containerRect.left,
        top: playerRectAbs.top - containerRect.top,
        bottom: playerRectAbs.bottom - containerRect.top
      };
      tiles.forEach((tile, i) => {
        const tileRect = getTileRect(tile);
        const crop = tileCrops[i];
        if (isColliding(playerRect, tileRect) && crop && crop.planted && crop.stage === 3) {
          tileCrops[i] = null;
          wheatCount++;
          totalWheatHarvested++;
          wheatSeedCount++;
          updateWheatMenu();
          renderTiles();
        }
      });
      if (wheatSeedCount < 0) wheatSeedCount = 0;
      updateWheatMenu();
    }

    setInterval(spawnGrass, 10000);

    function movePlayer() {
      if (!wheatMenuWindowVisible) {
        let newX = posX;
        let newY = posY;
        if (keys.w) newY = Math.max(0, posY - speed);
        if (keys.a) newX = Math.max(0, posX - speed);
        if (keys.s) newY = Math.min(containerSize - playerSize, posY + speed);
        if (keys.d) newX = Math.min(containerSize - playerSize, posX + speed);

        if (canMove(newX, newY)) {
          posX = newX;
          posY = newY;
        }
        player.style.top = posY + 'px';
        player.style.left = posX + 'px';

        const containerRect = player.parentElement.getBoundingClientRect();
        const playerRectAbs = player.getBoundingClientRect();
        const playerRect = {
          left: playerRectAbs.left - containerRect.left,
          right: playerRectAbs.right - containerRect.left,
          top: playerRectAbs.top - containerRect.top,
          bottom: playerRectAbs.bottom - containerRect.top
        };
        const buildingRectAbs = building.getBoundingClientRect();
        const buildingRect = {
          left: buildingRectAbs.left - containerRect.left,
          right: buildingRectAbs.right - containerRect.left,
          top: buildingRectAbs.top - containerRect.top,
          bottom: buildingRectAbs.bottom - containerRect.top
        };

        shopTab.style.display = isColliding(playerRect, buildingRect) ? 'block' : 'none';

        wetNearbyTiles();
        renderTiles();
        checkGrassPickup();
        plantSeedOnTile();
        harvestWheat();
      }
      requestAnimationFrame(movePlayer);
    }

    function selectTool(tool) {
      const toolIcons = {
        'hoe': 'ü™í',
        'watering-can': 'üíß',
        'shovel': 'üõ†Ô∏è'
      };
      selectedTool = tool;
      player.innerText = toolIcons[tool] || '';
    }

    renderTiles();
    movePlayer();

    // ---- SHOP BUTTONS LOGIC ----
    function updateCoinsDisplay() {
      document.getElementById('coinCount').innerText = coins.toFixed(1);
    }
    document.getElementById('sellSeedsBtn').onclick = function() {
      if (wheatSeedCount > 0) {
        coins += 0.5;
        wheatSeedCount--;
        updateCoinsDisplay();
        updateWheatMenu();
      } else {
        alert("You have no seeds to sell!");
      }
    };
    document.getElementById('sellWheatBtn').onclick = function() {
      if (wheatCount > 0) {
        coins += 1;
        wheatCount--;
        updateCoinsDisplay();
        updateWheatMenu();
      } else {
        alert("You have no wheat to sell!");
      }
    };
    // Ensure coin counter updates at start
    updateCoinsDisplay();
  </script>
</div>

</body>

</html>
